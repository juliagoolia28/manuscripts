---
title: "Mediation Manuscript"
author: "Julie M. Schneider"
date: "`r format(Sys.Date())`"
output:
   html_document:
    toc: true
    toc_depth: 2
    number_sections: true
    css: style.css
---

```{r setup, include=FALSE, cache=F}
knitr::opts_chunk$set(fig.width=6, fig.height=4, fig.path='Figs/', echo=TRUE, tidy=TRUE, message=F, warning=F, cache=T)
```

## Library Import
```{r,include=FALSE,echo=FALSE,warning=FALSE}
#Loading library
library(ez); library(ggplot2); library(multcomp); library(nlme); library(pastecs); library(reshape)
library(Hmisc); library (WRS2); library(lme4); library(lmerTest); library(plyr); library(splitstackshape) 
library(naniar); library(tidyr); library(dplyr); library(memisc); library(psychReport); library(foreign); library(interactions); library(tableone); library(officer); library(magrittr); library(corrplot); library(effectsize)

julie.theme <- theme_bw() + theme(axis.line = element_line(colour = "black"), panel.grid.minor = element_blank(), panel.grid.major = element_blank(), panel.border = element_blank(), panel.background = element_blank(), legend.title= element_blank())  #custom graphics theme for ggplot2
```

## Import and merge data
```{r,include=FALSE,echo=FALSE,warning=FALSE}
setwd("/Users/julieschneider/Julie_Personal/Projects/FLUX20/")
df= read.spss("SPSS_Input_noMatEdorLangKnow.sav", to.data.frame=TRUE)
```

### Remove Outlier
```{r}
df$subject<-as.factor(as.character(df$subject))
df<-df[-(4),]
```


### Create column for Age
```{r}
df$age_year<- ifelse(df$age_months < 108, 8, ifelse(df$age_months >= 108 & df$age_months < 120, 9, ifelse(df$age_months >= 120 & df$age_months < 132, 10, ifelse(df$age_months >= 132 & df$age_months < 144, 11, ifelse(df$age_months >= 144 & df$age_months < 156, 12, ifelse(df$age_months >= 156 & df$age_months < 168,13, ifelse(df$age_months >= 168 & df$age_months < 180, 14,ifelse(df$age_months >= 180 & df$age_months < 192, 15,ifelse(df$age_months > 192, 16,99)))))))))
```

### Use Complete Cases of Data Only
```{r}
myvars <- c("WL_PC","Zlangexp","ZHLE_comp","PPVT_SS","GORT_ORI","Zmat_ed","Zage_months","chaos","GORT_rate","GORT_fluency","GORT_acc","GORT_comp","gender", "mat_ed","age_months", "age_year", "lang_exp")
newdf <- df[myvars]
df <- newdf[complete.cases(newdf), ] 
write.csv(df,"complete_cases_regression.csv")
```

## SES related gaps in word learning
```{r}
onePredictorModel <- lm(WL_PC ~ Zage_months + Zlangexp + ZHLE_comp, df)
twoPredictorModel <- lm(WL_PC ~ Zage_months + Zlangexp + ZHLE_comp + Zmat_ed, df)
threePredictorModel <- lm(WL_PC ~ Zlangexp + Zage_months*Zmat_ed + Zage_months*ZHLE_comp, df)

summary(onePredictorModel)
effectsize(onePredictorModel)
summary(twoPredictorModel)
effectsize(twoPredictorModel)
summary(threePredictorModel)
effectsize(threePredictorModel)

interact_plot(threePredictorModel, pred = Zage_months, modx = ZHLE_comp, plot.points = TRUE)
```

## Vocabulary Regression
```{r}
vocab_model <-lm(WL_PC ~ Zlangexp + ZHLE_comp+ GORT_ORI+ Zmat_ed*PPVT_SS*Zage_months, df)

summary(vocab_model)

effectsize(vocab_model)
```

### Plot Interaction
```{r}
jpeg("Figs/vocab_regression.jpeg")
ggplot(df, aes(x=PPVT_SS, y = WL_PC)) + labs(title="Vocabulary predicts Word Learning Ability", y = "Word Learning Accuracy", x = "Vocabulary") + geom_point(size=2,color='#E69F00') + julie.theme+ theme(plot.title = element_text(hjust = 0.5)) + geom_smooth(method=lm,  linetype="dashed",
             color="black")
dev.off()
```

## Reading & Age Hierarchical Regression
```{r}
read_Model <- lm(WL_PC ~ Zlangexp + ZHLE_comp + PPVT_SS+ Zage_months*Zmat_ed*GORT_ORI, df)

summary(read_Model)

effectsize(read_Model)

sim_slopes(read_Model, pred = GORT_ORI, modx = Zage_months, mod2 = Zmat_ed, johnson_neyman = FALSE)
```

### Plot Interaction
```{r}
jpeg("Figs/interaction_reading_plot.jpeg", width = 8, height = 4)
interact_plot(read_Model, pred = GORT_ORI, modx = Zage_months, mod2 = Zmat_ed, geom = "line",interval = TRUE)
dev.off()

interact_plot(read_Model, pred = GORT_ORI, modx = Zage_months, geom = "line",
interval = TRUE)
```

## Reading down into Sub-Categories 
```{r}
read_Model <- lm(WL_PC ~ Zlangexp + ZHLE_comp + PPVT_SS+ Zage_months*Zmat_ed*GORT_ORI, df)

summary(read_Model)

effectsize(read_Model)

sim_slopes(read_Model, pred = GORT_ORI, modx = Zage_months, mod2 = Zmat_ed, johnson_neyman = FALSE)

sim_slopes(read_Model, pred = Zage_months, modx = Zmat_ed, johnson_neyman = FALSE)

sim_slopes(read_Model, pred = GORT_ORI, modx = Zage_months, johnson_neyman = FALSE)

jpeg("Figs/reading_regression.jpeg")
ggplot(df, aes(x=GORT_ORI, y = WL_PC)) + labs(title="Reading predicts Word Learning Ability", y = "Word Learning Accuracy", x = "Reading") + geom_point(size=2,color='#E69F00') + julie.theme+ theme(plot.title = element_text(hjust = 0.5)) + geom_smooth(method=lm,  linetype="dashed",
             color="black")
dev.off()
```

## Reading down into Sub-Categories 
```{r}
rate_model <- lm(WL_PC ~ Zlangexp + ZHLE_comp+ PPVT_SS+ Zmat_ed*GORT_rate*Zage_months, df)
fluency_model <- lm(WL_PC ~ Zlangexp + ZHLE_comp+ PPVT_SS+ Zmat_ed*GORT_fluency*Zage_months, df)
acc_model <- lm(WL_PC ~ Zlangexp + ZHLE_comp+ PPVT_SS+ Zmat_ed*GORT_acc*Zage_months, df)
comp_model <- lm(WL_PC ~ Zlangexp + ZHLE_comp+ PPVT_SS+ Zmat_ed*GORT_comp*Zage_months, df)

summary(rate_model)
effectsize(rate_model)
summary(fluency_model)
effectsize(fluency_model)
summary(acc_model)
effectsize(acc_model)
summary(comp_model)
effectsize(comp_model)

sim_slopes(rate_model, pred = GORT_rate, modx = Zage_months, johnson_neyman = FALSE)
sim_slopes(fluency_model, pred = GORT_fluency, modx = Zage_months, johnson_neyman = FALSE)
sim_slopes(acc_model, pred = GORT_acc, modx = Zage_months, johnson_neyman = FALSE)
sim_slopes(comp_model, pred = GORT_comp, modx = Zage_months, johnson_neyman = FALSE)

sim_slopes(acc_model, pred = GORT_acc, modx = Zmat_ed, johnson_neyman = FALSE)
pdf("Figs/readingacc_interaction_regression.pdf")
interact_plot(acc_model, pred = GORT_acc, modx = Zmat_ed, geom = "line",
interval = TRUE)
dev.off()
```

### Plot rate sub-category interaction
```{r}
interact_plot(rate_model, pred = GORT_rate, modx = Zage_months, plot.points = TRUE)
```

```{r}
interact_plot(fluency_model, pred = GORT_fluency, modx = Zage_months, plot.points = TRUE)
```

```{r}
interact_plot(acc_model, pred = GORT_acc, modx = Zage_months, plot.points = TRUE)
```

```{r}
interact_plot(comp_model, pred = GORT_comp, modx = Zmat_ed, plot.points = TRUE)
```


## Create Demographic Tables
```{r}
## Organizing Data by Mat Ed
catvars <- c("gender", "mat_ed", "lang_exp","age_year")

table2 <- CreateTableOne(myvars, df, catvars, strata = c("mat_ed"))
table2
#write.table(table2, file = "demo_stats.txt", sep = ",", quote = FALSE, row.names = T)

## Organizing Outcome Measures
sumstat <- df %>%

    # Select and rename five variables 
    select(
        `Word Learning (%)` = WL_PC,
        `Vocabulary` = PPVT_SS,
        `Reading overall` = GORT_ORI,
        `Reading rate` = GORT_rate,
        `Reading fluency` = GORT_fluency,
        `Reading accuracy`= GORT_acc,
        `Reading comprehension`= GORT_comp,
        `Language experience` = `lang_exp`,
        ) %>%

    # Find the mean, st. dev., min, and max for each variable 
    summarise_each(funs(mean, sd, min, max)) %>%

    # Move summary stats to columns
    gather(key, value, everything()) %>% 
    separate(key, into = c("variable", "stat"), sep = "_") %>%
    spread(stat, value) %>%

    # Set order of summary statistics 
    select(variable, mean, sd, min, max) %>%

    # Round all numeric variables to one decimal point
    mutate_each(funs(round(., 1)), -variable)

sumstat
write.table(sumstat, file = "sumstats.txt", sep = ",", quote = FALSE, row.names = F)
```

## Correlation between Language Measures
```{r}
mycorrvars <- c("WL_PC","Zlangexp","PPVT_SS","GORT_ORI","mat_ed","age_months")
df_subset <- df[mycorrvars]

#Overall Correlation
overall_corr<-rcorr(as.matrix(df_subset))
corrplot(overall_corr$r, method = "color", type = "upper",addCoef.col="dark grey", tl.col = "black", p.mat = overall_corr$P, sig.level = 0.05, insig = "blank", tl.cex = 0.9)

#Partial Correlation, where each bivariate comparison controls for all other variables in matrix
#par_overall_corr <- partial.cor(df_subset, tests=TRUE, use=c("pairwise.complete.obs"))
#pdf(file = "partial_corr_behavior_adjusted.pdf")
#corrplot(par_overall_corr$R, method = "color", type = "upper",addCoef.col="black", tl.col = "black", p.mat = par_overall_corr$P.unadj, sig.level = 0.05, insig = "blank", tl.cex = 0.9)
#dev.off()

#Correlation between specific variables, while controlling for a specific variable
source("pcor.R")
pcor.test(df$PPVT_SS, df$age_months, df$Zmat_ed, use = c("mat"), method = c("pearson"), na.rm = T)
pcor.test(df$PPVT_SS, y = df$age_months, 
          z = df[, c("mat_ed", "Zlangexp", "GORT_ORI")])
```



